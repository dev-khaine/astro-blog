---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { SITE_TITLE } from '../../consts';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog', p => !p.data.draft))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const allTags = [...new Set(posts.flatMap(p => p.data.tags || []))].sort();
const totalPosts = posts.length;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead
      title={`Analysis Archive — ${SITE_TITLE}`}
      description={`${totalPosts} articles on markets, finance, and the global economy.`}
    />
  </head>
  <body>
    <Header />
    <main id="main-content">
      <!-- Page header -->
      <div class="archive-header">
        <div class="arch-top anim-up">
          <h1 class="arch-title">Analysis</h1>
          <span class="arch-count label">{totalPosts} articles</span>
        </div>
        <div class="divider-rule" aria-hidden="true"></div>
      </div>

      <!-- Filters -->
      <div class="filter-bar anim-up anim-up-1" role="search">
        <div class="search-box">
          <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="search-icon"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <label for="q" class="sr-only">Search articles</label>
          <input id="q" type="search" placeholder="Search articles…" autocomplete="off" aria-label="Search articles" />
        </div>

        {allTags.length > 0 && (
          <div class="tag-bar" role="group" aria-label="Filter by topic">
            <button class="tag active" data-tag="all">All</button>
            {allTags.map(t => (
              <button class="tag" data-tag={t}>{t}</button>
            ))}
          </div>
        )}
      </div>

      <!-- Results count -->
      <div class="results-info" aria-live="polite" aria-atomic="true" id="results-count">
        <span id="results-text" class="label">Showing {totalPosts} articles</span>
      </div>

      <!-- Post table -->
      <div id="post-list" role="feed" aria-label="Article archive">
        {posts.map((post, i) => (
          <article
            class="post-item"
            data-title={post.data.title.toLowerCase()}
            data-desc={(post.data.description || '').toLowerCase()}
            data-tags={(post.data.tags || []).join(' ').toLowerCase()}
            role="article"
          >
            <a href={`/blog/${post.id}/`} class="post-item-link">
              <!-- Number -->
              <span class="pi-num label" aria-hidden="true">
                {String(totalPosts - i).padStart(2, '0')}
              </span>

              <!-- Main -->
              <div class="pi-main">
                <div class="pi-meta">
                  {post.data.tags && post.data.tags.slice(0,2).map((t: string) => (
                    <span class="tag" aria-hidden="true">{t}</span>
                  ))}
                  <time class="pi-date" datetime={post.data.pubDate.toISOString()}>
                    <FormattedDate date={post.data.pubDate} />
                  </time>
                </div>
                <h2 class="pi-title">{post.data.title}</h2>
                <p class="pi-desc">{post.data.description}</p>
              </div>

              <!-- Thumb -->
              {post.data.heroImage && (
                <div class="pi-thumb" aria-hidden="true">
                  <img src={post.data.heroImage} alt="" width={160} height={100} loading="lazy" decoding="async" />
                </div>
              )}

              <!-- Arrow -->
              <span class="pi-arrow" aria-hidden="true">→</span>
            </a>
          </article>
        ))}
      </div>

      <!-- No results -->
      <div id="no-results" hidden class="no-results" aria-live="polite">
        <p class="label">No articles found</p>
        <p>Try a different search term or clear the filters.</p>
        <button id="clear-all" class="btn btn-outline">Clear all filters</button>
      </div>
    </main>
    <Footer />
  </body>
</html>

<style>
  /* ── HEADER ── */
  .archive-header { padding-block: var(--sp-xl) var(--sp-md); }

  .arch-top {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: var(--sp-md);
  }

  .arch-title {
    font-size: clamp(5rem, 10vw, 9rem);
    line-height: 0.9;
    letter-spacing: 0.04em;
  }

  .arch-count { font-size: var(--s-xl); }

  .divider-rule {
    height: 1px;
    background: linear-gradient(90deg, var(--gold), var(--border), transparent);
  }

  /* ── FILTERS ── */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: var(--sp-sm);
    align-items: center;
    padding-block: var(--sp-md);
    border-bottom: 1px solid var(--border);
    margin-bottom: var(--sp-sm);
  }

  .search-box {
    position: relative;
    flex: 1;
    min-width: 200px;
    max-width: 340px;
  }

  .search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--fg-subtle);
    pointer-events: none;
  }

  #q { padding-left: 2.25rem; height: 38px; }

  .tag-bar { display: flex; flex-wrap: wrap; gap: 0.35rem; }

  .results-info {
    padding-block: var(--sp-xs);
    margin-bottom: var(--sp-md);
  }

  /* ── POST LIST ── */
  #post-list {
    display: flex;
    flex-direction: column;
    border-top: 1px solid var(--border);
  }

  .post-item { border-bottom: 1px solid var(--border); }

  .post-item-link {
    display: grid;
    grid-template-columns: 52px 1fr auto 28px;
    gap: var(--sp-md);
    align-items: center;
    padding: var(--sp-md) var(--sp-xs);
    text-decoration: none;
    color: inherit;
    border-radius: var(--r-sm);
    transition: background var(--t1), padding var(--t1);
  }
  .post-item-link:hover { background: var(--bg-raised); padding-inline: var(--sp-md); }

  .pi-num {
    font-family: var(--font-display);
    font-size: var(--s-3xl);
    color: var(--border-hi);
    text-align: center;
    line-height: 1;
    transition: color var(--t1);
  }
  .post-item-link:hover .pi-num { color: var(--gold-dim); }

  .pi-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-bottom: 0.3rem;
  }

  .pi-date {
    font-family: var(--font-mono);
    font-size: var(--s-2xs);
    color: var(--fg-subtle);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .pi-title {
    font-family: var(--font-display);
    font-size: var(--s-2xl);
    line-height: 0.95;
    letter-spacing: 0.025em;
    text-transform: uppercase;
    color: var(--fg);
    margin-bottom: 0.3rem;
    transition: color var(--t1);
  }
  .post-item-link:hover .pi-title { color: var(--gold); }

  .pi-desc {
    font-family: var(--font-sans);
    font-size: var(--s-sm);
    font-weight: 300;
    color: var(--fg-muted);
    line-height: 1.55;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .pi-thumb {
    width: 130px;
    aspect-ratio: 16/10;
    border-radius: var(--r-sm);
    overflow: hidden;
    border: 1px solid var(--border);
    flex-shrink: 0;
  }
  .pi-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: 0; display: block; }

  .pi-arrow {
    font-family: var(--font-mono);
    font-size: 1rem;
    color: var(--fg-subtle);
    transition: color var(--t1), transform var(--t1);
  }
  .post-item-link:hover .pi-arrow { color: var(--gold); transform: translateX(3px); }

  /* ── NO RESULTS ── */
  .no-results {
    text-align: center;
    padding: var(--sp-2xl) var(--sp-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--sp-sm);
  }
  .no-results p {
    font-family: var(--font-mono);
    color: var(--fg-subtle);
    font-size: var(--s-xs);
    letter-spacing: 0.06em;
  }
  .no-results p:first-child { color: var(--fg-muted); font-size: var(--s-lg); }

  [hidden] { display: none !important; }

  /* ── RESPONSIVE ── */
  @media (max-width: 640px) {
    .post-item-link { grid-template-columns: 36px 1fr 20px; }
    .pi-thumb { display: none; }
    .pi-num { font-size: var(--s-xl); }
    .arch-title { font-size: 4rem; }
  }
</style>

<script>
  const searchEl = document.getElementById('q') as HTMLInputElement | null;
  const noResults = document.getElementById('no-results');
  const clearAllBtn = document.getElementById('clear-all');
  const resultsText = document.getElementById('results-text');
  const tagBtns = document.querySelectorAll<HTMLButtonElement>('button[data-tag]');
  const items = document.querySelectorAll<HTMLElement>('.post-item');

  let query = '';
  let activeTag = 'all';

  const filter = () => {
    let count = 0;
    items.forEach(item => {
      const title = item.dataset.title || '';
      const desc = item.dataset.desc || '';
      const tags = item.dataset.tags || '';
      const show = (!query || title.includes(query) || desc.includes(query)) &&
                   (activeTag === 'all' || tags.includes(activeTag.toLowerCase()));
      item.hidden = !show;
      if (show) count++;
    });
    if (noResults) noResults.hidden = count > 0;
    if (resultsText) resultsText.textContent = `Showing ${count} article${count !== 1 ? 's' : ''}`;
  };

  searchEl?.addEventListener('input', () => {
    query = searchEl.value.toLowerCase().trim();
    filter();
  });

  tagBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      activeTag = btn.dataset.tag || 'all';
      tagBtns.forEach(b => b.classList.toggle('active', b === btn));
      filter();
    });
  });

  clearAllBtn?.addEventListener('click', () => {
    query = '';
    activeTag = 'all';
    if (searchEl) searchEl.value = '';
    tagBtns.forEach(b => b.classList.toggle('active', b.dataset.tag === 'all'));
    filter();
  });
</script>