---
export const prerender = true;
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { SITE_TITLE } from '../../consts';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog').then(posts => posts.filter(p => p.data && !p.data.draft)))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const allTags = [...new Set(posts.flatMap(p => p.data.tags || []))].sort();
const totalPosts = posts.length;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead
      title={`Articles — ${SITE_TITLE}`}
      description={`${totalPosts} articles on finance, crypto, tech, and the digital economy.`}
    />
  </head>
  <body>
    <Header />
    <main id="main-content">

      <!-- Page header -->
      <div class="archive-header">
        <div class="arch-top anim-up">
          <h1 class="arch-title">
            <span class="en-text">Articles</span>
            <span class="ar-text">المقالات</span>
          </h1>
          <span class="arch-count label">{totalPosts}
            <span class="en-text">articles</span>
            <span class="ar-text">مقالة</span>
          </span>
        </div>
        <div class="divider-rule" aria-hidden="true"></div>
      </div>

      <!-- Filters -->
      <div class="filter-bar anim-up anim-up-1" role="search">
        <div class="search-box">
          <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="search-icon"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <label for="q" class="sr-only">
            <span class="en-text">Search articles</span>
            <span class="ar-text">ابحث في المقالات</span>
          </label>
          <input id="q" type="search" autocomplete="off" aria-label="Search articles" />
        </div>

        {allTags.length > 0 && (
          <div class="tag-bar" role="group" aria-label="Filter by topic">
            <button class="tag active" data-tag="all">
              <span class="en-text">All</span>
              <span class="ar-text">الكل</span>
            </button>
            {allTags.map(t => (
              <button class="tag" data-tag={t}>{t}</button>
            ))}
          </div>
        )}
      </div>

      <!-- Results count -->
      <div class="results-info" aria-live="polite" aria-atomic="true" id="results-count">
        <span id="results-text" class="label">
          <span class="en-text">Showing {totalPosts} articles</span>
          <span class="ar-text">عرض {totalPosts} مقالة</span>
        </span>
      </div>

      <!-- Post table -->
      <div id="post-list" role="feed" aria-label="Article archive">
        {posts.map((post, i) => (
          <article
            class="post-item"
            data-title={post.data.title.toLowerCase()}
            data-title-ar={(post.data.title_ar || '').toLowerCase()}
            data-desc={(post.data.description || '').toLowerCase()}
            data-desc-ar={(post.data.description_ar || '').toLowerCase()}
            data-tags={(post.data.tags || []).join(' ').toLowerCase()}
            role="article"
          >
            <a href={`/blog/${post.id}/`} class="post-item-link">
              <!-- Number -->
              <span class="pi-num label" aria-hidden="true">
                {String(totalPosts - i).padStart(2, '0')}
              </span>

              <!-- Main -->
              <div class="pi-main">
                <div class="pi-meta">
                  {post.data.tags && post.data.tags.slice(0, 2).map((t: string) => (
                    <span class="tag" aria-hidden="true">{t}</span>
                  ))}
                  <time class="pi-date" datetime={post.data.pubDate.toISOString()}>
                    <FormattedDate date={post.data.pubDate} />
                  </time>
                </div>

                <!-- Bilingual title -->
                <h2 class="pi-title">
                  {post.data.title_ar ? (
                    <>
                      <span class="en-text">{post.data.title}</span>
                      <span class="ar-text">{post.data.title_ar}</span>
                    </>
                  ) : post.data.title}
                </h2>

                <!-- Bilingual description -->
                <p class="pi-desc">
                  {post.data.description_ar ? (
                    <>
                      <span class="en-text">{post.data.description}</span>
                      <span class="ar-text">{post.data.description_ar}</span>
                    </>
                  ) : post.data.description}
                </p>
              </div>

              <!-- Thumb -->
              {post.data.heroImage && (
                <div class="pi-thumb" aria-hidden="true">
                  <img src={post.data.heroImage} alt="" width={160} height={100} loading="lazy" decoding="async" />
                </div>
              )}

              <!-- Arrow -->
              <span class="pi-arrow" aria-hidden="true">
                <span class="en-text">→</span>
                <span class="ar-text">←</span>
              </span>
            </a>
          </article>
        ))}
      </div>

      <!-- No results -->
      <div id="no-results" hidden class="no-results" aria-live="polite">
        <p class="label">
          <span class="en-text">No articles found</span>
          <span class="ar-text">لا توجد مقالات</span>
        </p>
        <p>
          <span class="en-text">Try a different search term or clear the filters.</span>
          <span class="ar-text">جرب كلمة بحث مختلفة أو امسح الفلاتر.</span>
        </p>
        <button id="clear-all" class="btn btn-outline">
          <span class="en-text">Clear all filters</span>
          <span class="ar-text">مسح الفلاتر</span>
        </button>
      </div>
    </main>
    <Footer />
  </body>
</html>

<style>
  /* ── HEADER ── */
  .archive-header { padding-block: var(--sp-xl) var(--sp-md); }

  .arch-top {
    display: flex; align-items: baseline; justify-content: space-between;
    gap: 1rem; margin-bottom: var(--sp-md);
  }

  .arch-title {
    font-size: clamp(5rem, 10vw, 9rem); line-height: 0.9; letter-spacing: 0.04em;
  }
  [dir="rtl"] .arch-title { font-family: var(--font-arabic); font-weight: 700; text-transform: none; letter-spacing: 0; line-height: 1.1; }

  .arch-count { font-size: var(--s-xl); }

  .divider-rule {
    height: 1px;
    background: linear-gradient(90deg, var(--gold), var(--border), transparent);
  }
  [dir="rtl"] .divider-rule {
    background: linear-gradient(270deg, var(--gold), var(--border), transparent);
  }

  /* ── FILTERS ── */
  .filter-bar {
    display: flex; flex-wrap: wrap; gap: var(--sp-sm); align-items: center;
    padding-block: var(--sp-md); border-bottom: 1px solid var(--border);
    margin-bottom: var(--sp-sm);
  }

  .search-box { position: relative; flex: 1; min-width: 200px; max-width: 340px; }

  .search-icon {
    position: absolute; left: 0.75rem; top: 50%;
    transform: translateY(-50%); color: var(--fg-subtle); pointer-events: none;
  }
  [dir="rtl"] .search-icon { left: auto; right: 0.75rem; }

  #q { padding-left: 2.25rem; height: 38px; }
  [dir="rtl"] #q { padding-left: 1em; padding-right: 2.25rem; }

  .tag-bar { display: flex; flex-wrap: wrap; gap: 0.35rem; }

  .results-info { padding-block: var(--sp-xs); margin-bottom: var(--sp-md); }

  /* ── POST LIST ── */
  #post-list { display: flex; flex-direction: column; border-top: 1px solid var(--border); }

  .post-item { border-bottom: 1px solid var(--border); }

  .post-item-link {
    display: grid; grid-template-columns: 52px 1fr auto 28px;
    gap: var(--sp-md); align-items: center;
    padding: var(--sp-md) var(--sp-xs);
    text-decoration: none; color: inherit;
    border-radius: var(--r-sm);
    transition: background var(--t1), padding var(--t1);
  }
  .post-item-link:hover { background: var(--bg-raised); padding-inline: var(--sp-md); }

  .pi-num {
    font-family: var(--font-display); font-size: var(--s-3xl);
    color: var(--border-hi); text-align: center; line-height: 1; transition: color var(--t1);
  }
  [dir="rtl"] .pi-num { font-family: var(--font-arabic); font-weight: 700; font-size: var(--s-2xl); letter-spacing: 0; }
  .post-item-link:hover .pi-num { color: var(--gold-dim); }

  .pi-meta { display: flex; align-items: center; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.3rem; }

  .pi-date {
    font-family: var(--font-mono); font-size: var(--s-2xs);
    color: var(--fg-subtle); letter-spacing: 0.08em; text-transform: uppercase;
  }
  [dir="rtl"] .pi-date { font-family: var(--font-arabic); letter-spacing: 0; }

  .pi-title {
    font-family: var(--font-display); font-size: var(--s-2xl); line-height: 0.95;
    letter-spacing: 0.025em; text-transform: uppercase;
    color: var(--fg); margin-bottom: 0.3rem; transition: color var(--t1);
  }
  [dir="rtl"] .pi-title { font-family: var(--font-arabic); font-weight: 700; text-transform: none; letter-spacing: 0; line-height: 1.3; }
  .post-item-link:hover .pi-title { color: var(--gold); }

  .pi-desc {
    font-family: var(--font-sans); font-size: var(--s-sm); font-weight: 300;
    color: var(--fg-muted); line-height: 1.55; margin: 0;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  [dir="rtl"] .pi-desc { font-family: var(--font-arabic); font-weight: 400; line-height: 1.7; }

  .pi-thumb { width: 130px; aspect-ratio: 16/10; border-radius: var(--r-sm); overflow: hidden; border: 1px solid var(--border); flex-shrink: 0; }
  .pi-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: 0; display: block; }

  .pi-arrow {
    font-family: var(--font-mono); font-size: 1rem;
    color: var(--fg-subtle); transition: color var(--t1), transform var(--t1);
  }
  .post-item-link:hover .pi-arrow { color: var(--gold); }
  [dir="ltr"] .post-item-link:hover .pi-arrow { transform: translateX(3px); }
  [dir="rtl"] .post-item-link:hover .pi-arrow { transform: translateX(-3px); }

  /* ── NO RESULTS ── */
  .no-results {
    text-align: center; padding: var(--sp-2xl) var(--sp-sm);
    display: flex; flex-direction: column; align-items: center; gap: var(--sp-sm);
  }
  .no-results p { font-family: var(--font-mono); color: var(--fg-subtle); font-size: var(--s-xs); letter-spacing: 0.06em; }
  .no-results p:first-child { color: var(--fg-muted); font-size: var(--s-lg); }
  [dir="rtl"] .no-results p { font-family: var(--font-arabic); letter-spacing: 0; }

  [hidden] { display: none !important; }

  /* ── RESPONSIVE ── */
  @media (max-width: 640px) {
    .post-item-link { grid-template-columns: 36px 1fr 20px; }
    .pi-thumb { display: none; }
    .pi-num { font-size: var(--s-xl); }
    .arch-title { font-size: 4rem; }
  }
</style>

<script>
  var searchEl  = document.getElementById('q');
  var noResults = document.getElementById('no-results');
  var clearAllBtn = document.getElementById('clear-all');
  var resultsText = document.getElementById('results-text');
  var tagBtns = document.querySelectorAll('button[data-tag]');
  var items   = document.querySelectorAll('.post-item');

  // Update search placeholder based on lang
  function updateSearchPlaceholder() {
    var lang = document.documentElement.getAttribute('data-lang') || 'en';
    if (searchEl) {
      searchEl.placeholder = lang === 'ar' ? 'ابحث في المقالات…' : 'Search articles…';
    }
  }
  updateSearchPlaceholder();
  new MutationObserver(updateSearchPlaceholder).observe(document.documentElement, {
    attributes: true, attributeFilter: ['data-lang']
  });

  var query = '';
  var activeTag = 'all';

  function filter() {
    var lang = document.documentElement.getAttribute('data-lang') || 'en';
    var count = 0;
    items.forEach(function (item) {
      // Search both EN and AR fields so filter works in both languages
      var title    = item.dataset.title    || '';
      var titleAr  = item.dataset.titleAr  || '';
      var desc     = item.dataset.desc     || '';
      var descAr   = item.dataset.descAr   || '';
      var tags     = item.dataset.tags     || '';

      var matchQuery = !query ||
        title.includes(query) || titleAr.includes(query) ||
        desc.includes(query)  || descAr.includes(query);

      var matchTag = activeTag === 'all' || tags.includes(activeTag.toLowerCase());

      var show = matchQuery && matchTag;
      item.hidden = !show;
      if (show) count++;
    });

    if (noResults) noResults.hidden = count > 0;

    // Update results text
    if (resultsText) {
      var lang2 = document.documentElement.getAttribute('data-lang') || 'en';
      var enSpan = resultsText.querySelector('.en-text');
      var arSpan = resultsText.querySelector('.ar-text');
      if (enSpan) enSpan.textContent = 'Showing ' + count + ' article' + (count !== 1 ? 's' : '');
      if (arSpan) arSpan.textContent = 'عرض ' + count + ' مقالة';
    }
  }

  if (searchEl) {
    searchEl.addEventListener('input', function () {
      query = searchEl.value.toLowerCase().trim();
      filter();
    });
  }

  tagBtns.forEach(function (btn) {
    btn.addEventListener('click', function () {
      activeTag = btn.dataset.tag || 'all';
      tagBtns.forEach(function (b) {
        b.classList.toggle('active', b === btn);
      });
      filter();
    });
  });

  if (clearAllBtn) {
    clearAllBtn.addEventListener('click', function () {
      query = '';
      activeTag = 'all';
      if (searchEl) searchEl.value = '';
      tagBtns.forEach(function (b) {
        b.classList.toggle('active', b.dataset.tag === 'all');
      });
      filter();
    });
  }
</script>
