---
export const prerender = true;
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { SITE_TITLE } from '../consts';
import { getCollection } from 'astro:content';

// Fetch all published posts and pass them to the client as JSON
const posts = (await getCollection('blog', p => !p.data.draft))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .map(p => ({
    id:          p.id,
    title:       p.data.title,
    description: p.data.description ?? '',
    tags:        p.data.tags ?? [],
    pubDate:     p.data.pubDate.toISOString(),
    heroImage:   p.data.heroImage ?? '',
    url:         `/blog/${p.id}/`,
  }));
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead
      title={`Search — ${SITE_TITLE}`}
      description={`Search ${posts.length} articles across ${SITE_TITLE}.`}
      noindex={true}
    />
  </head>
  <body>
    <Header />

    <main id="main-content">
      <!-- Page heading -->
      <div class="search-header">
        <h1 class="search-title anim-up">Search</h1>
        <p class="search-sub anim-up anim-up-1">
          {posts.length} articles indexed
        </p>
        <div class="title-rule anim-up anim-up-1" aria-hidden="true"></div>
      </div>

      <!-- Search input -->
      <div class="search-box-wrap anim-up anim-up-2" role="search">
        <label for="search-input" class="sr-only">Search articles</label>
        <div class="search-field">
          <svg class="search-field-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input
            id="search-input"
            type="search"
            placeholder="Search articles, topics, keywords…"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            aria-label="Search articles"
            aria-controls="search-results"
            aria-autocomplete="list"
          />
          <button id="clear-btn" class="clear-btn" aria-label="Clear search" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
            </svg>
          </button>
        </div>

        <!-- Keyboard hint -->
        <p class="search-hint" aria-live="polite" id="search-hint">
          Type to search · <kbd>↑</kbd><kbd>↓</kbd> navigate · <kbd>Enter</kbd> open · <kbd>Esc</kbd> clear
        </p>
      </div>

      <!-- Recent searches -->
      <div id="recent-wrap" class="recent-wrap" aria-label="Recent searches" hidden>
        <p class="recent-label label">Recent searches</p>
        <div id="recent-list" class="recent-list" role="list"></div>
      </div>

      <!-- Results -->
      <div
        id="search-results"
        class="results-wrap"
        role="listbox"
        aria-label="Search results"
        aria-live="polite"
        aria-atomic="false"
      ></div>

      <!-- Empty state (shown before typing) -->
      <div id="empty-state" class="empty-state" aria-hidden="true">
        <div class="empty-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
        </div>
        <p class="empty-heading label">Search the archive</p>
        <p class="empty-desc">Markets, macro, investing, crypto — start typing to find what you're looking for.</p>

        <!-- Browse by topic -->
        <div id="all-tags" class="all-tags" role="group" aria-label="Browse by topic"></div>
      </div>

      <!-- No results state -->
      <div id="no-results" class="no-results" hidden aria-live="polite">
        <div class="empty-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><path d="M8 11h6"/>
          </svg>
        </div>
        <p class="empty-heading label">No results found</p>
        <p class="empty-desc" id="no-results-desc">Try different keywords or browse by topic below.</p>
        <div id="no-results-tags" class="all-tags" role="group" aria-label="Browse by topic"></div>
      </div>
    </main>

    <Footer />
  </body>
</html>

<!-- Pass post data to client -->
<script define:vars={{ posts }}>
  // ─── DATA ────────────────────────────────────────────────────────────────
  const ALL_POSTS = posts;

  // Collect unique tags
  const ALL_TAGS = [...new Set(ALL_POSTS.flatMap(p => p.tags))].sort();

  // ─── DOM REFS ────────────────────────────────────────────────────────────
  const input       = document.getElementById('search-input');
  const clearBtn    = document.getElementById('clear-btn');
  const resultsEl   = document.getElementById('search-results');
  const emptyState  = document.getElementById('empty-state');
  const noResults   = document.getElementById('no-results');
  const noResultsDesc = document.getElementById('no-results-desc');
  const hintEl      = document.getElementById('search-hint');
  const recentWrap  = document.getElementById('recent-wrap');
  const recentList  = document.getElementById('recent-list');
  const allTagsEl   = document.getElementById('all-tags');
  const noTagsEl    = document.getElementById('no-results-tags');

  // ─── RECENT SEARCHES (localStorage) ─────────────────────────────────────
  const RECENT_KEY = 'capital_recent_searches';
  const MAX_RECENT = 6;

  const getRecent = () => {
    try { return JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); } catch { return []; }
  };

  const saveRecent = (q) => {
    if (!q || q.length < 2) return;
    const list = [q, ...getRecent().filter(r => r !== q)].slice(0, MAX_RECENT);
    try { localStorage.setItem(RECENT_KEY, JSON.stringify(list)); } catch {}
  };

  const renderRecent = () => {
    const list = getRecent();
    if (!list.length) { recentWrap.hidden = true; return; }
    recentWrap.hidden = false;
    recentList.innerHTML = list.map(r => `
      <button class="recent-pill" data-query="${r}" role="option" aria-selected="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        ${r}
      </button>
    `).join('');

    recentList.querySelectorAll('.recent-pill').forEach(btn => {
      btn.addEventListener('click', () => {
        input.value = btn.dataset.query;
        input.focus();
        runSearch(btn.dataset.query);
      });
    });
  };

  // ─── TAG PILLS ───────────────────────────────────────────────────────────
  const renderTags = (container) => {
    if (!container) return;
    container.innerHTML = ALL_TAGS.map(t => `
      <button class="tag browse-tag" data-tag="${t}">${t}</button>
    `).join('');
    container.querySelectorAll('.browse-tag').forEach(btn => {
      btn.addEventListener('click', () => {
        input.value = btn.dataset.tag;
        input.dispatchEvent(new Event('input'));
        input.focus();
      });
    });
  };

  // ─── HIGHLIGHT HELPER ────────────────────────────────────────────────────
  const highlight = (text, query) => {
    if (!query || !text) return text;
    const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    return text.replace(new RegExp(`(${escaped})`, 'gi'), '<mark>$1</mark>');
  };

  // ─── SEARCH LOGIC ────────────────────────────────────────────────────────
  const score = (post, q) => {
    const ql = q.toLowerCase();
    const title  = post.title.toLowerCase();
    const desc   = post.description.toLowerCase();
    const tags   = post.tags.join(' ').toLowerCase();

    if (title.includes(ql))       return 3;
    if (tags.includes(ql))        return 2;
    if (desc.includes(ql))        return 1;
    // word-by-word fallback
    const words = ql.split(/\s+/).filter(Boolean);
    if (words.length > 1 && words.every(w => (title + ' ' + desc + ' ' + tags).includes(w))) return 0.5;
    return 0;
  };

  const search = (q) => {
    if (!q) return ALL_POSTS;
    return ALL_POSTS
      .map(p => ({ post: p, score: score(p, q) }))
      .filter(x => x.score > 0)
      .sort((a, b) => b.score - a.score)
      .map(x => x.post);
  };

  // ─── RENDER RESULTS ──────────────────────────────────────────────────────
  let focusIndex = -1;

  const renderResults = (results, q) => {
    focusIndex = -1;

    if (!results.length) {
      resultsEl.innerHTML = '';
      noResultsDesc.textContent = `No results for "${q}". Try different keywords.`;
      noResults.hidden = false;
      emptyState.hidden = true;
      renderTags(noTagsEl);
      return;
    }

    noResults.hidden = true;
    emptyState.hidden = true;

    const countLabel = results.length === 1
      ? '1 result'
      : `${results.length} results`;

    resultsEl.innerHTML = `
      <p class="results-count label" aria-live="polite">${countLabel} for "<span class="results-query">${q}</span>"</p>
      <div class="results-list">
        ${results.map((p, i) => `
          <a
            href="${p.url}"
            class="result-row"
            role="option"
            aria-selected="false"
            data-index="${i}"
            tabindex="-1"
          >
            ${p.heroImage ? `
            <div class="result-thumb" aria-hidden="true">
              <img src="${p.heroImage}" alt="" width="120" height="75" loading="lazy" decoding="async" />
            </div>` : ''}
            <div class="result-body">
              <div class="result-meta">
                ${p.tags.slice(0, 2).map(t => `<span class="tag result-tag">${highlight(t, q)}</span>`).join('')}
                <time class="result-date" datetime="${p.pubDate}">
                  ${new Date(p.pubDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                </time>
              </div>
              <h2 class="result-title">${highlight(p.title, q)}</h2>
              <p class="result-desc">${highlight(p.description, q)}</p>
            </div>
            <span class="result-arrow" aria-hidden="true">→</span>
          </a>
        `).join('')}
      </div>
    `;
  };

  // ─── KEYBOARD NAVIGATION ─────────────────────────────────────────────────
  const getRows = () => [...resultsEl.querySelectorAll('.result-row')];

  const setFocus = (idx) => {
    const rows = getRows();
    if (!rows.length) return;
    focusIndex = Math.max(0, Math.min(idx, rows.length - 1));
    rows.forEach((r, i) => {
      r.setAttribute('aria-selected', String(i === focusIndex));
      if (i === focusIndex) r.focus();
    });
  };

  input.addEventListener('keydown', (e) => {
    const rows = getRows();
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      rows.length ? setFocus(focusIndex < 0 ? 0 : focusIndex + 1) : null;
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (focusIndex <= 0) { input.focus(); focusIndex = -1; }
      else setFocus(focusIndex - 1);
    } else if (e.key === 'Escape') {
      clearSearch();
    }
  });

  resultsEl.addEventListener('keydown', (e) => {
    const rows = getRows();
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      setFocus(focusIndex + 1);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (focusIndex <= 0) { input.focus(); focusIndex = -1; }
      else setFocus(focusIndex - 1);
    } else if (e.key === 'Escape') {
      clearSearch();
      input.focus();
    }
  });

  // ─── MAIN SEARCH HANDLER ─────────────────────────────────────────────────
  let debounceTimer;

  const runSearch = (q) => {
    const trimmed = q.trim();

    clearBtn.hidden = !trimmed;

    if (!trimmed) {
      resultsEl.innerHTML = '';
      noResults.hidden = true;
      emptyState.hidden = false;
      recentWrap.hidden = getRecent().length === 0;
      hintEl.textContent = "Type to search · ↑↓ navigate · Enter open · Esc clear";
      return;
    }

    emptyState.hidden = true;
    recentWrap.hidden = true;

    const results = search(trimmed);
    renderResults(results, trimmed);

    hintEl.textContent = results.length
      ? `${results.length} result${results.length !== 1 ? 's' : ''} — ↑↓ to navigate, Enter to open`
      : `No results for "${trimmed}"`;
  };

  input.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => runSearch(e.target.value), 120);
  });

  // Save to recent on Enter or blur (if query has results)
  const trySaveRecent = () => {
    const q = input.value.trim();
    if (q.length >= 2 && search(q).length > 0) {
      saveRecent(q);
      renderRecent();
    }
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && focusIndex < 0) trySaveRecent();
  });
  input.addEventListener('blur', trySaveRecent);

  // ─── CLEAR ───────────────────────────────────────────────────────────────
  const clearSearch = () => {
    input.value = '';
    runSearch('');
    renderRecent();
  };

  clearBtn.addEventListener('click', () => {
    clearSearch();
    input.focus();
  });

  // ─── INIT ─────────────────────────────────────────────────────────────────
  // Render tag browser in empty state
  renderTags(allTagsEl);

  // Show recent searches if any
  renderRecent();

  // Check for ?q= in URL
  const urlQ = new URLSearchParams(window.location.search).get('q');
  if (urlQ) {
    input.value = urlQ;
    runSearch(urlQ);
  } else {
    emptyState.hidden = false;
  }

  // Auto-focus the input on load
  input.focus();

  // Update URL as user types (without pushing history)
  input.addEventListener('input', () => {
    const q = input.value.trim();
    const url = new URL(window.location.href);
    if (q) { url.searchParams.set('q', q); }
    else   { url.searchParams.delete('q'); }
    history.replaceState(null, '', url.toString());
  });
</script>

<style>
  /* ─── PAGE LAYOUT ─── */
  main {
    width: min(800px, 100% - 2.5rem);
    margin-inline: auto;
    padding-block: var(--sp-xl) var(--sp-2xl);
  }

  /* ─── HEADER ─── */
  .search-header {
    margin-bottom: var(--sp-lg);
  }

  .search-title {
    font-family: var(--font-display);
    font-size: clamp(5rem, 12vw, 8rem);
    line-height: 0.9;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--fg);
    margin-bottom: 0.3em;
  }

  .search-sub {
    font-family: var(--font-mono);
    font-size: var(--s-xs);
    color: var(--fg-subtle);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin: 0 0 var(--sp-md);
  }

  .title-rule {
    height: 1px;
    background: linear-gradient(90deg, var(--gold), var(--border), transparent);
  }

  /* ─── SEARCH FIELD ─── */
  .search-box-wrap {
    margin-block: var(--sp-lg);
  }

  .search-field {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-field-icon {
    position: absolute;
    left: 1rem;
    color: var(--fg-subtle);
    pointer-events: none;
    flex-shrink: 0;
    transition: color 0.15s;
  }

  #search-input {
    width: 100%;
    height: 56px;
    padding-left: 3rem;
    padding-right: 3rem;
    font-family: var(--font-sans);
    font-size: var(--s-lg);
    font-weight: 300;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    color: var(--fg);
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  #search-input:focus {
    border-color: var(--gold-dim);
    box-shadow: 0 0 0 3px var(--gold-glow);
  }

  #search-input:focus ~ .search-field-icon,
  .search-field:focus-within .search-field-icon {
    color: var(--gold-dim);
  }

  #search-input::placeholder {
    color: var(--fg-subtle);
    font-style: italic;
  }

  /* clear button */
  .clear-btn {
    position: absolute;
    right: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    border: none;
    border-radius: var(--r-sm);
    background: var(--bg-raised);
    color: var(--fg-muted);
    cursor: pointer;
    transition: background 0.11s, color 0.11s;
  }
  .clear-btn:hover {
    background: var(--gold-glow);
    color: var(--gold);
  }

  .search-hint {
    font-family: var(--font-mono);
    font-size: var(--s-2xs);
    color: var(--fg-subtle);
    letter-spacing: 0.06em;
    margin-top: 0.6rem;
    margin-bottom: 0;
  }

  kbd {
    display: inline-block;
    padding: 0.05em 0.35em;
    font-family: var(--font-mono);
    font-size: 0.8em;
    border: 1px solid var(--border-hi);
    border-radius: 3px;
    background: var(--bg-raised);
    color: var(--fg-muted);
    line-height: 1.4;
  }

  /* ─── RECENT SEARCHES ─── */
  .recent-wrap {
    margin-bottom: var(--sp-md);
  }

  .recent-label {
    margin-bottom: 0.6rem;
    display: block;
  }

  .recent-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .recent-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.4em;
    padding: 0.3em 0.8em;
    font-family: var(--font-mono);
    font-size: var(--s-2xs);
    letter-spacing: 0.06em;
    text-transform: uppercase;
    border: 1px solid var(--border);
    border-radius: var(--r-sm);
    background: var(--bg-card);
    color: var(--fg-muted);
    cursor: pointer;
    transition: border-color 0.11s, color 0.11s, background 0.11s;
  }
  .recent-pill:hover {
    border-color: var(--gold-dim);
    color: var(--gold);
    background: var(--gold-glow);
  }

  /* ─── RESULTS ─── */
  .results-count {
    margin-bottom: var(--sp-sm);
    padding-bottom: var(--sp-sm);
    border-bottom: 1px solid var(--border);
  }

  .results-query { color: var(--gold); }

  .results-list {
    display: flex;
    flex-direction: column;
  }

  .result-row {
    display: grid;
    grid-template-columns: 120px 1fr 24px;
    gap: var(--sp-md);
    align-items: center;
    padding: var(--sp-md) var(--sp-xs);
    border-bottom: 1px solid var(--border);
    text-decoration: none;
    color: inherit;
    border-radius: var(--r-sm);
    outline: none;
    transition: background 0.11s;
  }

  .result-row:hover,
  .result-row:focus,
  .result-row[aria-selected="true"] {
    background: var(--bg-raised);
    padding-inline: var(--sp-sm);
    margin-inline: calc(-1 * var(--sp-sm));
  }

  .result-row[aria-selected="true"] {
    border-left: 2px solid var(--gold);
    padding-left: calc(var(--sp-sm) - 2px);
  }

  .result-thumb {
    width: 120px;
    aspect-ratio: 16 / 10;
    border-radius: var(--r-sm);
    overflow: hidden;
    border: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--bg-raised);
  }
  .result-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 0;
  }

  .result-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-bottom: 0.3rem;
  }

  .result-tag { pointer-events: none; }

  .result-date {
    font-family: var(--font-mono);
    font-size: var(--s-2xs);
    color: var(--fg-subtle);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .result-title {
    font-family: var(--font-display);
    font-size: var(--s-2xl);
    line-height: 0.95;
    letter-spacing: 0.025em;
    text-transform: uppercase;
    color: var(--fg);
    margin-bottom: 0.3rem;
    transition: color 0.11s;
  }
  .result-row:hover .result-title,
  .result-row:focus .result-title,
  .result-row[aria-selected="true"] .result-title { color: var(--gold); }

  .result-desc {
    font-family: var(--font-sans);
    font-size: var(--s-sm);
    font-weight: 300;
    color: var(--fg-muted);
    line-height: 1.55;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .result-arrow {
    font-family: var(--font-mono);
    color: var(--fg-subtle);
    transition: color 0.11s, transform 0.11s;
    font-size: 1rem;
  }
  .result-row:hover .result-arrow,
  .result-row:focus .result-arrow,
  .result-row[aria-selected="true"] .result-arrow {
    color: var(--gold);
    transform: translateX(3px);
  }

  /* Highlighted match text */
  mark {
    background: var(--gold-glow);
    color: var(--gold-bright);
    border-radius: 2px;
    padding: 0 0.1em;
    font-style: normal;
  }

  /* ─── EMPTY / NO-RESULTS STATES ─── */
  .empty-state,
  .no-results {
    padding-block: var(--sp-xl);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--sp-sm);
  }

  .empty-icon {
    color: var(--fg-subtle);
    margin-bottom: var(--sp-xs);
    opacity: 0.5;
  }

  .empty-heading {
    font-size: var(--s-xl);
    margin: 0;
  }

  .empty-desc {
    font-family: var(--font-sans);
    font-size: var(--s-sm);
    color: var(--fg-muted);
    font-weight: 300;
    max-width: 420px;
    line-height: 1.6;
    font-style: italic;
    margin: 0;
  }

  .all-tags {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.4rem;
    margin-top: var(--sp-xs);
    max-width: 500px;
  }

  /* ─── RESPONSIVE ─── */
  @media (max-width: 600px) {
    .result-row { grid-template-columns: 1fr 20px; }
    .result-thumb { display: none; }
    #search-input { font-size: var(--s-md); height: 50px; }
    .search-title { font-size: 4.5rem; }
  }
</style>
